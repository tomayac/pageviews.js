/**
 * @license
 * Copyright 2017 Thomas Steiner (@tomayac). All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0

 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
var request,USER_AGENT="pageviews.js",environment="undefined"==typeof window?"node":"browser";if("node"===environment){request=require("request");var packageJson=require("./package.json");USER_AGENT="pageviews.js-v"+packageJson.version+" ("+packageJson.repository.url+")"}else request=function(e,r){var t=new XMLHttpRequest;t.addEventListener("load",function(){return r(null,{statusCode:this.status},this.responseText)}),t.addEventListener("error",function(e){return r(e)}),t.open("GET",e.url),t.send()};var pageviews=function(){var e="https://wikimedia.org/api/rest_v1",r={"default":"all-access",allowed:["all-access","desktop","mobile-web","mobile-app"]},t={"default":"all-sites",allowed:["all-sites","desktop-site","mobile-site","all-access"]},a={"default":"all-agents",allowed:["all-agents","user","spider","bot"]},n={"default":"hourly",allowed:["daily","hourly","monthly"]},i={"default":"daily",allowed:["daily","monthly"]},s={"default":"daily",allowed:["daily","monthly"]},o=function(e,o){var l=function(e){return 10>e?"0"+e:e.toString()};if(!e)return new Error("Required parameters missing.");if(!e.project&&!e.projects)return new Error("getAggregatedPageviews"===o||"getTopPageviews"===o||"getAggregatedLegacyPagecounts"===o?'Required parameter "project" or "projects" missing.':'Required parameter "project" missing.');if(e.project&&"all-projects"!==e.project&&"wikidata"!==e.project&&-1===e.project.indexOf("."))return new Error('Required parameter "project" invalid.');if(!("getAggregatedPageviews"!==o&&"getAggregatedLegacyPagecounts"!==o&&"getTopPageviews"!==o||!e.projects||"all-projects"==e.projects||Array.isArray(e.projects)&&e.projects.length&&!e.projects.filter(function(e){return-1===e.indexOf(".")&&"all-projects"!==e&&"wikidata"!==e}).length))return new Error('Required parameter "projects" invalid.');if("getPerArticlePageviews"===o){if(!e.article&&!e.articles)return new Error('Required parameter "article" or "articles" missing.');if(e.articles&&(!Array.isArray(e.articles)||!e.articles.length))return new Error('Required parameter "articles" invalid.')}if("getPerArticlePageviews"===o||"getUniqueDevices"===o){if(!e.start)return new Error('Required parameter "start" missing.');if(e.start="object"==typeof e.start?e.start.getUTCFullYear()+l(e.start.getUTCMonth()+1)+l(e.start.getUTCDate()):e.start,!/^(?:19|20)\d\d[- \/.]?(?:0[1-9]|1[012])[- \/.]?(?:0[1-9]|[12][0-9]|3[01])$/.test(e.start))return new Error('Required parameter "start" invalid.');if(!e.end)return new Error('Required parameter "end" missing.');if(e.end="object"==typeof e.end?e.end.getUTCFullYear()+l(e.end.getUTCMonth()+1)+l(e.end.getUTCDate()):e.end,!/^(19|20)\d\d[- \/.]?(0[1-9]|1[012])[- \/.]?(0[1-9]|[12][0-9]|3[01])$/.test(e.end))return new Error('Required parameter "end" invalid.')}else if("getAggregatedPageviews"===o||"getAggregatedLegacyPagecounts"===o){if(!e.start)return new Error('Required parameter "start" missing.');if(e.start="object"==typeof e.start?e.start.getUTCFullYear()+l(e.start.getUTCMonth()+1)+(l(e.start.getUTCDate())+l(e.start.getUTCHours())):e.start,!/^(?:19|20)\d\d[- \/.]?(?:0[1-9]|1[012])[- \/.]?(?:0[1-9]|[12][0-9]|3[01])[- \/.]?(?:[012][0-9])$/.test(e.start))return new Error('Required parameter "start" missing or invalid.');if(!e.end)return new Error('Required parameter "end" missing.');if(e.end="object"==typeof e.end?e.end.getUTCFullYear()+l(e.end.getUTCMonth()+1)+l(e.end.getUTCDate())+l(e.end.getUTCHours()):e.end,!/^(19|20)\d\d[- \/.]?(0[1-9]|1[012])[- \/.]?(0[1-9]|[12][0-9]|3[01])[- \/.]?(?:[012][0-9])$/.test(e.end))return new Error('Required parameter "end" missing or invalid.')}if("getTopPageviews"===o){if(e.date&&(e.date="object"==typeof e.date?e.date:new Date(e.date.substr(0,4)+"-"+e.date.substr(4,2)+"-"+e.date.substr(6,2)),e.year=e.date.getUTCFullYear(),e.month=l(e.date.getUTCMonth()+1),e.day=l(e.date.getUTCDate())),!e.year||!/^(?:19|20)\d\d$/.test(e.year))return new Error('Required parameter "year" missing or invalid.');if(!e.month||!/^(?:0?[1-9]|1[012])$/.test(e.month))return new Error('Required parameter "month" missing or invalid.');if(!e.day||!/^(?:0?[1-9]|[12][0-9]|3[01])$/.test(e.day))return new Error('Required parameter "day" missing or invalid.');if(e.limit&&!/^\d+$/.test(e.limit)&&0<e.limit&&e.limit<=1e3)return new Error('Invalid optional parameter "limit".')}if(e.access&&-1===r.allowed.indexOf(e.access))return new Error('Invalid optional parameter "access".');if(e.accessSite&&-1===t.allowed.indexOf(e.accessSite))return new Error('Invalid optional parameter "accessSite".');if(e.agent&&-1===a.allowed.indexOf(e.agent))return new Error('Invalid optional parameter "agent".');if(e.granularity)if("getAggregatedPageviews"===o||"getAggregatedLegacyPagecounts"===o){if(-1===n.allowed.indexOf(e.granularity))return new Error('Invalid optional parameter "granularity".')}else if("getPerArticlePageviews"===o){if(-1===i.allowed.indexOf(e.granularity))return new Error('Invalid optional parameter "granularity".')}else if("getUniqueDevices"===o&&-1===s.allowed.indexOf(e.granularity))return new Error('Invalid optional parameter "granularity".');return e},l=function(e,r,t){var a;if(e||200!==r.statusCode){if(e)return e;if(404===r.statusCode)try{return a=JSON.parse(t),new Error(a.detail||a.title)}catch(n){return new Error(n)}return new Error("Status code "+r.statusCode)}try{a=JSON.parse(t)}catch(n){return new Error(n)}return a},u=function(t){return new Promise(function(n,s){if(t=o(t,"getPerArticlePageviews"),t.stack)return s(t);if(t.articles){var c=[];return t.articles.map(function(e,r){var a=t;delete a.articles,a.article=e,c[r]=u(a)}),n(Promise.all(c))}var d=t.project,g=encodeURIComponent(t.article.replace(/\s/g,"_")),p=t.start,f=t.end,m=t.access?t.access:r["default"],v=t.agent?t.agent:a["default"],w=t.granularity?t.granularity:i["default"],y={url:e+"/metrics/pageviews/per-article/"+d+"/"+m+"/"+v+"/"+g+"/"+w+"/"+p+"/"+f,headers:{"User-Agent":USER_AGENT}};request(y,function(e,r,t){var a=l(e,r,t);return a.stack?s(a):n(a)})})},c=function(t){return new Promise(function(i,s){if(t=o(t,"getAggregatedPageviews"),t.stack)return s(t);if("all-projects"===t.projects&&(t.projects=null,t.project="all-projects"),t.projects){var u=[];return t.projects.map(function(e,r){var a=t;delete a.projects,a.project=e,u[r]=c(a)}),i(Promise.all(u))}var d=t.project,g=t.start,p=t.end,f=t.access?t.access:r["default"],m=t.agent?t.agent:a["default"],v=t.granularity?t.granularity:n["default"],w={url:e+"/metrics/pageviews/aggregate/"+d+"/"+f+"/"+m+"/"+v+"/"+g+"/"+p,headers:{"User-Agent":USER_AGENT}};request(w,function(e,r,t){var a=l(e,r,t);return a.stack?s(a):i(a)})})},d=function(r){return new Promise(function(a,i){if(r=o(r,"getAggregatedLegacyPagecounts"),r.stack)return i(r);if("all-projects"===r.projects&&(r.projects=null,r.project="all-projects"),r.projects){var s=[];return r.projects.map(function(e,t){var a=r;delete a.projects,a.project=e,s[t]=d(a)}),a(Promise.all(s))}var u=r.project,c=r.start,g=r.end,p=r.accessSite?r.accessSite:t["default"],f=r.granularity?r.granularity:n["default"],m={url:e+"/metrics/legacy/pagecounts/aggregate/"+u+"/"+p+"/"+f+"/"+c+"/"+g,headers:{"User-Agent":USER_AGENT}};request(m,function(e,r,t){var n=l(e,r,t);return n.stack?i(n):a(n)})})},g=function(t){return new Promise(function(a,n){if(t=o(t,"getTopPageviews"),t.stack)return n(t);if(t.projects){var i=[];return t.projects.map(function(e,r){var a=t;delete a.projects,a.project=e,i[r]=g(a)}),a(Promise.all(i))}var s=t.project,u=t.year,c="number"==typeof t.month&&t.month<10?"0"+t.month:t.month,d="number"==typeof t.day&&t.day<10?"0"+t.day:t.day,p=t.limit||!1,f=t.access?t.access:r["default"],m={url:e+"/metrics/pageviews/top/"+s+"/"+f+"/"+u+"/"+c+"/"+d,headers:{"User-Agent":USER_AGENT}};request(m,function(e,r,t){var i=l(e,r,t);return i.stack?n(i):(p&&(i.items[0].articles=i.items[0].articles.slice(0,p)),a(i))})})},p=function(){return new Promise(function(r,t){var a={url:e+"/metrics/pageviews/",headers:{"User-Agent":USER_AGENT}};request(a,function(e,a,n){var i=l(e,a,n);return i.stack?t(i):r(i)})})},f=function(r){return new Promise(function(a,n){if(r=o(r,"getUniqueDevices"),r.stack)return n(r);var i=r.project,u=r.start,c=r.end,d=r.accessSite?r.accessSite:t["default"],g=r.granularity?r.granularity:s["default"],p={url:e+"/metrics/unique-devices/"+i+"/"+d+"/"+g+"/"+u+"/"+c,headers:{"User-Agent":USER_AGENT}};request(p,function(e,r,t){var i=l(e,r,t);return i.stack?n(i):a(i)})})};return{getPageviewsDimensions:p,getPerArticlePageviews:u,getAggregatedPageviews:c,getAggregatedLegacyPagecounts:d,getTopPageviews:g,getUniqueDevices:f}}();"node"===environment&&(module.exports=pageviews);